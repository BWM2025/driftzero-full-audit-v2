name: ULTIMATE DRIFTZERO CTO AUDITOR â€“ FULL ON-GITHUB AUDIT

on:
  workflow_dispatch:    # You trigger it manually

jobs:
  full-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download & unzip all phases
        run: |
          mkdir -p codebase
          for zip in phase-*.zip; do
            echo "Unzipping $zip"
            unzip -o "$zip" -d codebase/
          done
          echo "Total files:" $(find codebase -type f | wc -l)

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install full audit toolchain
        run: |
          pip install pytest coverage mypy black bandit trivy
          sudo apt-get update && sudo apt-get install -y unzip curl

      - name: Run the complete audit suite
        run: |
          cd codebase
          # 1. File manifest + SHA-256
          find . -type f -exec sha256sum {} \; | sort > ../driftzero_file_manifest.txt
          # 2. Code fingerprints (simplified)
          python -c "
import ast, json, os
result = []
for root, _, files in os.walk('.'):
    for f in files:
        if f.endswith('.py'):
            path = os.path.join(root, f)
            with open(path) as fh:
                tree = ast.parse(fh.read())
            classes = [n.name for n in ast.walk(tree) if isinstance(n, ast.ClassDef)]
            funcs = [n.name for n in ast.walk(tree) if isinstance(n, ast.FunctionDef)]
            result.append({'file': path, 'classes': classes, 'functions': funcs})
json.dump(result, open('../driftzero_code_fingerprints.json', 'w'), indent=2)
"
          # 3. Run all tests & static analysis
          pytest --cov=. --cov-report=xml || true
          mypy . || true
          black --check . || true
          bandit -r . || true

      - name: Upload all audit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ULTIMATE-DRIFTZERO-CTO-AUDIT-RESULTS
          path: |
            driftzero_file_manifest.txt
            driftzero_code_fingerprints.json
            coverage.xml
            *.log
