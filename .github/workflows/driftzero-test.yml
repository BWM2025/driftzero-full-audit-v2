ULTIMATE DRIFTZERO CTO AUDITOR â€“ FULL ON-GITHUB AUDIT

# This makes the green "Run workflow" button appear immediately
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  full-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Unzip all phases
        run: |
          mkdir -p codebase
          for zip in phase-*.zip; do
            echo "Unzipping $zip"
            unzip -o "$zip" -d codebase/ || echo "Skipped (empty or corrupt)"
          done
          echo "Total files found:"
          find codebase -type f | wc -l

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install audit tools
        run: |
          pip install --upgrade pip
          pip install pytest coverage mypy black bandit
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: Generate manifest + fingerprints + run scans
        run: |
          cd codebase

          # 1. Real SHA-256 manifest for every file
          find . -type f -exec sha256sum {} \; | sort > ../driftzero_file_manifest.txt
          echo "Manifest created with $(wc -l < ../driftzero_file_manifest.txt) lines"

          # 2. Code fingerprints (classes & functions)
          python -c "
import ast, json, os, sys
result = []
for root, _, files in os.walk('.'):
    for f in files:
        if f.endswith('.py'):
            path = os.path.join(root, f)
            try:
                with open(path, 'r', encoding='utf-8', errors='ignore') as fh:
                    tree = ast.parse(fh.read())
                classes = [n.name for n in ast.walk(tree) if isinstance(n, ast.ClassDef)]
                funcs   = [n.name for n in ast.walk(tree) if isinstance(n, ast.FunctionDef)]
                result.append({'file': path, 'classes': classes, 'functions': funcs})
            except Exception as e:
                print(f'Skip {path}: {e}', file=sys.stderr)
json.dump(result, open('../driftzero_code_fingerprints.json', 'w'), indent=2)
"
          echo "Fingerprints JSON created"

          # 3. Run all tools (never fail the whole job)
          pytest --cov=. --cov-report=xml || echo "pytest done"
          mypy . > ../mypy_report.txt 2>&1 || echo "mypy done"
          black --check . || echo "black done"
          bandit -r . > ../bandit_report.txt 2>&1 || echo "bandit done"
          trivy fs . > ../trivy_report.txt 2>&1 || echo "trivy done"

      - name: Upload results (even if some steps fail)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ULTIMATE-DRIFTZERO-CTO-AUDIT-RESULTS
          path: |
            driftzero_file_manifest.txt
            driftzero_code_fingerprints.json
            mypy_report.txt
            bandit_report.txt
            trivy_report.txt
            coverage.xml
