name: PHASE 1 — FORENSIC PROOF

on:
  workflow_dispatch
  pull_request:   # ← this line is the magic trick (we remove it in 3 minutes)

jobs:
  proof:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install unzip
        run: sudo apt-get update -qq && sudo apt-get install -y unzip

      - name: Extract phase-1.zip
        run: |
          unzip -o phase-1.zip

      - name: Generate the three files
        run: |
          find . -type f -not -path '*/\.git/*' -exec sha256sum {} \; | sort > manifest.txt
          find . -type f -not -path '*/\.git/*' | sort > filelist.txt
          python3 - <<'PY'
import ast, json
from pathlib import Path
result = []
for p in Path('.').rglob('*.py'):
    try:
        tree = ast.parse(p.read_text())
        classes = [n.name for n in ast.walk(tree) if isinstance(n, ast.ClassDef)]
        funcs   = [n.name for n in ast.walk(tree) if isinstance(n, ast.FunctionDef)]
        result.append({"file": str(p), "classes": classes, "functions": funcs})
    except:
        result.append({"file": str(p), "error": "parse failed"})
json.dump(result, open('fingerprints.json', 'w'), indent=2)
PY

      - name: Upload proof
        uses: actions/upload-artifact@v4
        with:
          name: PHASE1-REAL
          path: |
            manifest.txt
            filelist.txt  fingerprints.json
