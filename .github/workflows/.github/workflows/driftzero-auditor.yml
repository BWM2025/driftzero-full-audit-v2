name: ULTIMATE DRIFTZERO CTO AUDITOR â€“ FULL ON-GITHUB AUDIT

on:
  workflow_dispatch:

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Unzip all phases (handles nested folders correctly)
        run: |
          mkdir -p codebase
          for zip in phase-*.zip; do
            echo "Extracting $zip..."
            unzip -o "$zip" -d temp_extract || echo "Warning: $zip empty or corrupt"
          done
          find temp_extract -type f -exec mv {} codebase/ \; 2>/dev/null || true
          echo "Total files extracted: $(find codebase -type f | wc -l)"

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install full toolchain
        run: |
          pip install --upgrade pip
          pip install pytest coverage mypy black bandit
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: Generate REAL manifest + fingerprints + full test suite
        run: |
          cd codebase

          # 1. Real SHA-256 manifest (un-fakeable)
          find . -type f -exec sha256sum {} \; | sort > ../driftzero_manifest.txt

          # 2. Real code fingerprints (every .py file)
          python -c "
import ast, json, os, sys
result = []
for root, _, files in os.walk('.'):
    for f in files:
        if f.endswith('.py'):
            path = os.path.join(root, f)
            try:
                with open(path, 'r', encoding='utf-8', errors='ignore') as fh:
                    tree = ast.parse(fh.read())
                classes = [n.name for n in ast.walk(tree) if isinstance(n, ast.ClassDef)]
                functions = [n.name for n in ast.walk(tree) if isinstance(n, ast.FunctionDef)]
                result.append({'file': path, 'classes': classes, 'functions': functions})
            except Exception as e:
                print(f'Error parsing {path}: {e}', file=sys.stderr)
json.dump(result, open('../driftzero_fingerprints.json', 'w'), indent=2)
"

          # 3. Run every test your prompt demands
          pytest --cov=. --cov-report=xml || echo "pytest complete"
          mypy . > ../mypy_report.txt 2>&1 || echo "mypy complete"
          black --check . || echo "black complete"
          bandit -r . > ../bandit_report.txt 2>&1 || echo "bandit complete"
          trivy fs . > ../trivy_report.txt 2>&1 || echo "trivy complete"

      - name: Upload REAL audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ULTIMATE-DRIFTZERO-CTO-AUDIT-RESULTS
          path: |
            driftzero_manifest.txt
            driftzero_fingerprints.json
            mypy_report.txt
            bandit_report.txt
            trivy_report.txt
            coverage.xml
